<!DOCTYPE html>
<html>
  <head>
    <title></title>
    <script src="jquery.js"></script>
    <link rel="stylesheet" href="style.css">
  </head>
  <body>
    <div id="timer"></div>
    <button id="start" onclick="start()">Start</button>
    <div id="Test"></div>
    <div id="Controlos">
      <button id="prev" onclick="perguntaAnterior()">Anterior</button>
      <button onclick="acabarTeste()">Acabar o Teste</button>
      <button id="next" onclick="perguntaSeguinte()">Seguinte</button>
    </div>
  </body>
  <script>
    var IndexDeQuestoes = 0;
    var arrayQuestoes;

    var count = 45 * 60;
    var minutos = count / 60;
    var segundos = 0;

    var nrDeSelecionada = 0;

    var score = 0;

    function start() {
      var xmlhttp = new XMLHttpRequest();

      xmlhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
          arrayQuestoes = JSON.parse(this.responseText);
          fillQuestoes(arrayQuestoes);
        }
      };

      xmlhttp.open("GET", "Questoes.txt", true);
      xmlhttp.send();

      $("#start").css("display", "none");
      $("#prev").css("display", "none");

      countdown();

      return arrayQuestoes;
    }

    function fillQuestoes(arrayQuestoes) {
      var teste = $("#Test");
      let tam = arrayQuestoes.length;
      for(i=0; i<tam; i++) {
        $("#Test").append("<div id='Questao"+i+"'></div>");

        $("#Questao"+i).append("<div class='Questao'>"+arrayQuestoes[i].pergunta+"</div>");
        $("#Questao"+i).attr("class", "d-none");

        if(arrayQuestoes[i].tipo == "escolha unica") {
          for(j=0; j<4; j++) {
            $("#Questao"+i).append("<div id='Opcao_"+j+"' class='Opcao'>"+arrayQuestoes[i].opcoes[j]+"</div>");
            $("#Questao"+i).children("#Opcao_"+j).bind("click", opcaoSelecionada);
          }
        }

        if(arrayQuestoes[i].tipo == "escolha multipla") {
          for(j=0; j<4; j++) {
            $("#Questao"+i).append("<div id='Opcao_"+j+"' class='Opcao'>"+arrayQuestoes[i].opcoes[j]+"</div>");
            $("#Questao"+i).children("#Opcao_"+j).bind("click", opcaoSelecionada);
          }
        }

        if(arrayQuestoes[i].tipo == "V ou F") {
          for(j=0; j<2; j++) {
            $("#Questao"+i).append("<div id='Opcao_"+j+"' class='Opcao'>"+arrayQuestoes[i].opcoes[j]+"</div>");
            $("#Questao"+i).children("#Opcao_"+j).bind("click", opcaoSelecionada);
          }
        }

        if(arrayQuestoes[i].tipo == "completar") {
          $("#Questao"+i).append("<input type='text' value=''>")
        }
      }
      $("#Questao0").attr("class", "d-block");
    }

    function opcaoSelecionada() {
      if(arrayQuestoes[IndexDeQuestoes].tipo == "escolha multipla") {
        if($(this).css("background-color") == "rgb(0, 0, 0)") {
          $(this).css("background-color", "white");
          nrDeSelecionada--;
          return nrDeSelecionada;
        }else if(nrDeSelecionada < 2) {
          $(this).css("background-color", "rgb(0, 0, 0)");
          nrDeSelecionada++;
          return nrDeSelecionada;
        }
      }else {
        $(".Opcao").css("backgroundColor", "white");
        $(this).css("background-color", "rgb(0, 0, 0)");
      }
    }

    function perguntaAnterior() {
      $("#Questao"+IndexDeQuestoes).css("display", "none");
      IndexDeQuestoes--;
      $("#Questao"+IndexDeQuestoes).css("display", "inline");

      if(IndexDeQuestoes <= 0) {
        $("#prev").css("display", "none");
      }

      if($("#next").css("display") == "none") {
        $("#next").css("display", "inline");
      }
      return IndexDeQuestoes;
    }

    function perguntaSeguinte() {
      $("#Questao"+IndexDeQuestoes).children(".Opcao").unbind("click");
      $("#Questao"+IndexDeQuestoes).children(".Opcao").attr("class", "");

      $("#Questao"+IndexDeQuestoes).children("input").attr("readonly", true);

      $("#Questao"+IndexDeQuestoes).css("display", "none");
      IndexDeQuestoes++;
      $("#Questao"+IndexDeQuestoes).css("display", "inline");

      if(IndexDeQuestoes >= arrayQuestoes.length - 1) {
        $("#next").css("display", "none");
      }

      if($("#prev").css("display") == "none") {
        $("#prev").css("display", "inline");
      }

      return IndexDeQuestoes;
    }

    function acabarTeste() {
      checkResposta();
      alert(score);
    }

    function checkResposta() {
      for(i=0; i<arrayQuestoes.length; i++) {
        if(arrayQuestoes[i].tipo == "escolha unica") {
          for(j=0; j<4; j++) {
            var questaoSelecionada = $("#Questao"+i).children("#Opcao_"+j);
            if($(questaoSelecionada).css("background-color") == "rgb(0, 0, 0)") {
              if($(questaoSelecionada).text() == arrayQuestoes[i].resposta) {
                score+=5;
              }
            }
          }
        }else if(arrayQuestoes[i].tipo == "escolha multipla") {
          var nrOpcoesSelecionadas=0;
          for(j=0; j<4; j++) {
            var questaoSelecionada = $("#Questao"+i).children("#Opcao_"+j);
            if($(questaoSelecionada).css("background-color") == "rgb(0, 0, 0)") {
              for(s=0; s<2; s++) {
                if($(questaoSelecionada).text() == arrayQuestoes[i].resposta[s]) {
                  score+=2.5;
                }
              }
            }
          }
        }else if(arrayQuestoes[i].tipo == "V ou F") {
          for(j=0; j<2; j++) {
            var questaoSelecionada = $("#Questao"+i).children("#Opcao_"+j);
            if($(questaoSelecionada).css("background-color") == "rgb(0, 0, 0)") {
              if($(questaoSelecionada).text() == arrayQuestoes[i].resposta) {
                score+=5;
              }
            }
          }
        }else if(arrayQuestoes[i].tipo == "completar") {
          if($("#Questao"+i).children("input").val() == arrayQuestoes[i].resposta) {
            score+=5;
          }
        }
      }
      return score;
    }

    function countdown() {
      var time = setInterval(function () {
         if(count<2) {
           clearInterval(time);
         }
         count--;
         if(segundos > 0) {
           segundos--;
         }else{
           minutos--;
           segundos = 60;
         }
         $("#timer").html(minutos+":"+segundos);
      }, 1000);
    }
  </script>
</html>
